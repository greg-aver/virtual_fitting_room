# Архитектура приложения

## Принципы дизайна

1. **Минимализм** - каждый модуль решает одну конкретную задачу
2. **Асинхронность** - используется async/await для всех I/O операций
3. **Модульность** - четкое разделение ответственности между компонентами
4. **Отказоустойчивость** - обработка ошибок на каждом уровне

## Компоненты системы

### 1. Telegram Bot Layer (`bot/`)
- **Ответственность**: взаимодействие с пользователем
- **Модули**: handlers для обработки сообщений
- **Технологии**: aiogram 3.x с FSM для управления состояниями

### 2. LLM Integration Layer (`llm/`)
- **Ответственность**: интеграция с языковыми моделями
- **Модули**: clients для разных LLM провайдеров, templates для промптов
- **Технологии**: aiohttp для асинхронных HTTP запросов

### 3. Image Processing Layer (`image/`)
- **Ответственность**: обработка и валидация изображений
- **Модули**: validators для проверки корректности изображений
- **Технологии**: Pillow для работы с изображениями

### 4. Storage Layer (`storage/`)
- **Ответственность**: управление временными файлами и кэшем
- **Структура**: temp/ для временных файлов, cache/ для кэширования

### 5. Configuration Layer (`config/`)
- **Ответственность**: управление конфигурацией приложения
- **Технологии**: pydantic для валидации, python-dotenv для .env файлов

### 6. Utilities Layer (`utils/`)
- **Ответственность**: вспомогательные функции
- **Модули**: логирование через loguru

## Поток данных

```
Пользователь → Telegram Bot → Image Validator → File Storage → LLM Client → OpenAI API
     ↑                                                                            ↓
Response ← Text Processing ← LLM Response ← HTTP Client ← API Response ← OpenAI API
```

## Управление состояниями

Используется FSM (Finite State Machine) через aiogram:
1. `waiting_first_image` - ожидание первого изображения
2. `waiting_second_image` - ожидание второго изображения
3. `waiting_prompt` - ожидание текстового промпта

## Обработка ошибок

Каждый уровень имеет свою стратегию обработки ошибок:
- **Валидация изображений**: возврат None при некорректном файле
- **LLM запросы**: возврат сообщения об ошибке пользователю
- **Сохранение файлов**: логирование ошибки и уведомление пользователя

## Логирование

Централизованное логирование через loguru:
- Все операции логируются с соответствующим уровнем
- Ротация логов по дням
- Структурированный формат с временными метками