MESSAGES = {
    "hello": """Здравствуйте! Я ваш виртуальный помощник по примерке одежды.
Отправьте мне своё фото и фото одежды, и я помогу представить,
как вы будете выглядеть в этом наряде.
Просто следуйте моим подсказкам — вместе создадим идеальный образ!""",
    
    "ask_photo_person": "Пришлите свою фотографию",
    
    "ask_photo_cloth": "Пришлите мне фотографию одежды"
}

PROMPTS = {
    "default": """ 
# Выполни профессиональную виртуальную примерку одежды высокого коммерческого уровня

Используй изображение человека из `human_image` и фотографию одежды из `garment_image` для генерации итогового результата.

Результат должен выглядеть как студийный кадр для каталога премиум-бренда. Наложенная одежда должна максимально реалистично сочетаться с оригинальной фотографией — сохранена естественная анатомия, поза, пропорции и освещение модели.

## Основная задача

- Наложить одежду на модель так, чтобы сохранялась естественная посадка и реалистичное взаимодействие ткани с телом.
- Обеспечить точную передачу всех элементов одежды: текстура ткани, узоры, логотипы, швы, застежки и декоративные детали.
- Избегать искажений фигуры, переэкспонирования деталей или артефактов.
- Итоговое изображение должно быть профессионального качества, готовое к коммерческому использованию (интернет-магазины, каталоги).

---

## КРИТИЧЕСКОЕ ТРЕБОВАНИЕ: АБСОЛЮТНОЕ СОХРАНЕНИЕ АНАТОМИИ ЧЕЛОВЕКА
- Фигура, пропорции тела, размеры торса, бедер, талии должны остаться ИДЕНТИЧНЫМИ исходному изображению
- ЗАПРЕЩЕНО любое изменение телосложения, веса, мышечной массы или силуэта человека
- Одежда должна адаптироваться к СУЩЕСТВУЮЩЕЙ фигуре, а не изменять ее

## Технические параметры

mode: "quality" # финальный рендер в максимальном качестве  
mode_preview: "performance" # быстрый предпросмотр (экономия времени)  
category: "auto" # автоматическое определение типа одежды  
garment_photo_type: "auto" # автоматически различать фото: на модели, флет-лей или на манекене  
segmentation_free: true # использовать алгоритм без «отрезки» краёв, для естественного наложения  
output_format: "png" # PNG без сжатия для сохранения мелких деталей  
resolution_min: "576x864" # минимальное разрешение с сохранением пропорций

- Для garment_photo_type="mannequin" адаптируй посадку с учётом отсутствия анатомических изгибов — формируй естественный объём с опорой на тело человека.
- Если исходное фото с модели, приоритезируй сохранение естественной драпировки и складок, видимых на исходнике одежды.
- Для flat-lay генерируй собственные физически-реалистичные складки и объём.

### Дополнительные технические параметры

- timesteps: 30-50         # оптимальное число шагов диффузии
- guidance_scale: 1.8      # баланс между следованием промпту и разнообразием
- seed_control: "auto"     # контроль воспроизводимости результата
- num_inference_steps: 45  # точное количество итераций генерации
- adaptive_noise_scheduling: true # использовать адаптивное планирование шума в зависимости от сложности сцены
- progressive_resolution: true # сначала low-res, после — upscale
- selective_attention: true # использование увеличенного внимания к критическим областям одежды
- memory_optimization: "gradient_checkpointing, quantization" # экономия ресурсов

---

## Продвинутые решения проблем сегментации и маскирования

### Mask-Free обработка
- Применить mask-free технологию для автоматического определения областей замены без внешних масок
- Использовать self-attention механизмы для точного выделения одежды, исключая dependency от pre-trained парсеров
- Предотвращать mask leakage через полностью автоматическую сегментацию

### Расширенное маскирование (Dilated-Relaxed Strategy)
- Использовать dilated mask strategy для правильного покрытия всей длины одежды
- Предотвращать заполнение только части маскированной области при cross-category try-on
- Адаптировать размер маски под конкретный тип и размер одежды для полного устранения остаточных элементов

### Co-attention маскирование
- Применить joint learning для removed mask и try-on mask одновременно
- Использовать co-attention между изображением человека и одеждой для семантического разделения регионов
- Обеспечить точное определение границ без внешней сегментации

### Прогрессивное маскирование
- Генерировать маски поэтапно: coarse → medium → fine-grained для максимальной точности
- Использовать multi-scale mask refinement для точности границ одежды
- Применять mask validation на каждом этапе для предотвращения артефактов

### Улучшенная clothing-agnostic обработка
- Сохранять важные детали тела (руки, аксессуары, волосы) при удалении исходной одежды
- Использовать enhanced person representation с RGB skeleton guidance
- Предотвращать over-masking критически важных областей, сохраняя естественность

### Валидация масок через discriminator
- Применять discriminator rejection для фильтрации некорректных масок
- Использовать confidence scoring для оценки качества сегментации
- Автоматически переgenerировать маски при низком качестве для устранения остаточных элементов

### Семантические границы одежды
- Использовать semantic boundary detection для точных краев одежды
- Применять edge-aware loss для четких границ между одеждой и телом
- Интегрировать clothing-specific semantic information для предотвращения смешивания

### Категориально-специфичные маски
- Использовать разные подходы к маскированию для tops/bottoms/dresses
- Адаптировать размер и форму масок под тип одежды (жилетки требуют особой обработки границ)
- Применять category-aware mask generation для предотвращения остаточных элементов

### Сохранение текстур при маскировании
- Preserve skin textures в открытых областях при смене одежды
- Использовать texture-aware mask boundaries для плавных переходов
- Предотвращать texture bleeding между одеждой и телом

### Адаптивные пороги маскирования
- Динамически корректировать mask thresholds по условиям освещения
- Адаптировать к различным позам и углам съемки
- Использовать lighting-aware mask adjustment для консистентности

---

## Обязательные критерии качества (с весами)

1. **Посадка одежды — 30%**
   - Ткань должна повторять естественный изгиб тела модели, без жёстких складок и заломов. Натяжение ткани учитывается соответствующей позе.
2. **Анатомическая точность — 25%**
   - Лицо, плечи, руки и поза модели сохраняются без искажений. Никогда не деформировать конечности, осанку или пропорции.
3. **Детализация элементов — 25%**
   - Швы, пуговицы, строчки, логотипы и декоративные элементы должны быть чётко проработаны, читаемы, не размазаны даже при увеличении.
4. **Естественность освещения — 20%**
   - Тени и свет на одежде должны соответствовать источникам света с исходного фото модели. Освещение выглядит цельно и убедительно.
   - Определи характер освещения (мягкое/жёсткое, направление) на исходном фото человека и синхронизируй с освещением одежды.
   - Если исходник содержит несколько источников света, подстрой наложение так, чтобы тени на одежде были строго сонаправлены с тенями на теле.

---

## Негативные промпты для контроля артефактов

- Исключить: "деформированные руки, размытые лица, неестественные пропорции, двойные конечности, остаточная исходная одежда, неполная замена одежды".
- Избегать: "пиксельные артефакты, цветовые ореолы, нереалистичные тени, смазанные детали, mask leakage, неточная сегментация".
- Не генерировать: "лишние элементы одежды, искажённые логотипы, неправильную перспективу, видимые части исходной одежды".

---

## Специализированные инструкции по категориям одежды

### Tops (верхняя одежда)
- Проверять правильность проймы, ровность посадки воротника и рукавов.
- Исключить разрывы ткани и нереалистичные перепады на груди, ключицах.
- Обеспечить реалистичное натяжение ткани в области плеч и груди.

### Bottoms (низ)
- Брючины или юбки должны соответствовать предполагаемому росту модели, не «висеть» и не иметь лишних просветов.
- Формировать естественные складки в зоне коленей, бедер и паха.
- Внимательно прорабатывать область пояса, застёжек и швов.

### One-pieces (платья, комбинезоны)
- Сохранять цельный силуэт без искажений в области талии и бёдер.
- Появление поясных деталей, ремней, застёжек и карманов должно совпадать с позой и пропорциями.
- Не допускать смещения или смятых участков между верхом и низом.

---

## Детализация элементов и текстуры

- Передавать фактуру ткани (джинс, кожа, трикотаж) с реалистичным плетением волокон и рисунком.
- Логотипы, эмблемы и принты останутся чёткими, не размытыми, сохранят пропорции при наложении.
- Пуговицы, молнии, застёжки и декоративные элементы освещаются согласно световым условиям исходного фото.
- Цветовой профиль результата — строго sRGB, без клиппинга и пересветов.
- При наложении одежды сверяй итоговые цвета всех элементов с исходным garment_image через выбор эталонных участков. Не искажай цвет ткани, даже если исходный фон содержит мощные цветовые рефлексы — приоритет натуральной цветопередачи.

### Advanced texture transfer

- Использовать self-attention и high-frequency enhancement для сохранения сложных текстур, паттернов, строчек.
- Конкатенировать маскированное изображение с garment для пространственной точности.
- Включить cross-attention для ключевых деталей и мелких элементов.

### Высокочастотная детализация и validation

- Frequency-domain learning и validation для предотвращения пропадания деталей.  
- Проверять consistency паттернов, отсутствие разрывов и misalignments.

---

## Сохранение идентичности модели (точность ≥ 95%)

- Черты лица, цвет кожи, макияж и причёска остаются без изменений.
- Поза, пропорции конечностей, перспектива и ориентация тела полностью сохраняются.
- Аксессуары (очки, украшения и пр.) остаются на тех же местах без деформации, используются как опорные элементы.

---

## Инструкции по аксессуарам

- При наличии поясов, ремней, галстуков, шарфов: обеспечь их корректное наложение без перекрытия ключевых элементов одежды.
- Аксессуары не должны скрывать важные части одежды или создавать нереалистичные тени.
- Отдельно проверь положение и ориентацию украшений в зависимости от позы модели.
- Исключить style conflicts между garment и аксессуарами.
- Аксессуары должны интегрироваться семантически и визуально с одеждой и образом.

---

## Семантическое соответствие стиля

- При наложении одежды используй параметры стиля: casual, business, sport, luxury. Если стиль распознаётся автоматически — подбирай тип посадки и драпировку, логично сочетающиеся с образом.
- Не допускать конфликтов между стилем одежды и внешностью модели (например, строгий костюм с неформальной позой).
- Обеспечивать style coherence между всеми элементами.
- Валидировать fashion rules: color harmony, style matching.

- Реализовать occasion-based и brand-style conditioning.
- Для outfit'ов учитывать требования сезона, мероприятия и целевой аудитории.

---

## Автоматическая коррекция проблемных зон

- Особое внимание к обработке рук, волос и краёв одежды с приоритетом предотвращения «ореолов» и резких краёв.
- Плавное смешивание границ между тканью и кожей без сильно выраженных контуров.
- Обнаруженные ошибки (ломаные края, артефакты) должны инициировать автоматическую пересборку изображения до устранения.
- Автоматически детектировать типы артефактов: anatomical errors, texture blurring, color bleeding.
- Использовать confidence scoring, threshold для отбраковки плохих результатов.
- Применять error-aware noise scheduling и локальный multi-stage refinement.

---

## Работа с фоном

- Сохраняй исходный фон, не размывая его и не добавляя искусственных элементов.
- Если фон однотонный — избегай появления цветовых ореолов вокруг силуэта и края одежды.
- При сложном фоне — максимально точно интегрируй одежду без создания артефактов на границе.

---

## Адаптивная логика рендеринга в зависимости от типа фото одежды

- Если `garment_photo_type = "model"` — повторить естественную натяжку и форму ткани, ориентируясь на позу модели в одежде.
- Если `garment_photo_type = "flat-lay"` (фото на ровной поверхности) — сгенерировать объём и сложение ткани, соответствующее человеческой фигуре и позе.
- Для `garment_photo_type = "mannequin"` — создать естественный объём одежды на человеке, корректируя зоны, где манекен не повторяет анатомию.
- Перед финальным рендером переключить режим с `mode_preview = "performance"` на `mode = "quality"`.

### Prompt-aware и multimodal conditioning

- Динамически формировать and корректировать маски inpainting'а по описанию (tucked-in, loose-fit, cropped).
- Усилить conditioning по CLIP-embedding и pose-keypoints.
- Объединять текстовые и визуальные сигналы для более глубокого понимания образа.

---

## Контроль деформации на основе позы
- Использовать pose keypoints как ФИКСИРОВАННЫЕ опорные точки для сохранения пропорций
- Применять pose-aware constraints для предотвращения нереалистичных изменений тела
- Обеспечить correspondence между исходной позой и результатом без изменения размеров сегментов тела

---

## Сохранение измерений тела
- Сохранять точные измерения: обхват груди, талии, бедер из исходного изображения
- Применять anthropometric constraints для поддержания исходных пропорций
- Одежда должна масштабироваться под СУЩЕСТВУЮЩИЕ размеры тела, не наоборот
- Использовать body measurement validation для проверки соответствия результата исходнику

---

## Дополнительные рекомендации по computational efficiency и воспроизводимости

- Использовать progressive resolution и selective attention для ускорения.
- Включить memory optimization методы (gradient checkpointing, quantization).
- Контролировать seed, архивировать параметры сэмплинга для повторяемых результатов.

---

## Точная обработка границ тела
- Использовать precise body boundary detection для четкого разделения тела и одежды  
- Применять edge-aware loss для сохранения естественных контуров тела
- Предотвращать mask bleeding между телом и одеждой
- Использовать body-clothing disentanglement для разделения признаков тела и одежды
- Сохранять skin texture и body surface details в открытых областях

---

## Финальный выход

- Разрешение не меньше 576×864 пикселей с сохранением пропорций исходного изображения.
- Формат — PNG без сжатия для максимального сохранения качества деталей.
- Итоговое изображение готово к немедленному размещению на витрине интернет-магазина, не требует дальнейшей ретуши.

    """
}